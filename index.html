<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<meta name="theme-color" content="#0d9488">
<title>Everytin Room POS</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}html,body{height:100%;font-family:'Poppins',system-ui,sans-serif;background:linear-gradient(145deg,#f0fdfa 0%,#ccfbf1 50%,#fef3c7 100%);color:#134e4a}:root{--primary:#0d9488;--accent:#f59e0b;--success:#22c55e;--warning:#f59e0b;--danger:#ef4444;--dark:#134e4a;--white:#fff;--glass:rgba(255,255,255,.92);--shadow:0 8px 32px -8px rgba(13,148,136,.2);--gradient:linear-gradient(135deg,#0d9488,#14b8a6,#f59e0b);--safe-top:env(safe-area-inset-top);--safe-bottom:env(safe-area-inset-bottom)}
#loader{position:fixed;inset:0;background:var(--gradient);z-index:9999;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:20px;opacity:0;pointer-events:none;transition:.3s}#loader.on{opacity:1;pointer-events:auto}#loader .spin{width:50px;height:50px;border:4px solid rgba(255,255,255,.3);border-top-color:#fff;border-radius:50%;animation:spin 1s linear infinite}#loader p{color:#fff;font-size:16px;font-weight:600}#loader .brand{font-size:28px;font-weight:800;color:#fff}#loader .brand span{color:#fbbf24}@keyframes spin{to{transform:rotate(360deg)}}
#toast{position:fixed;top:100px;left:50%;transform:translateX(-50%) translateY(-30px);background:var(--dark);color:#fff;padding:14px 28px;border-radius:50px;font-size:14px;font-weight:600;z-index:9999;opacity:0;transition:.3s}#toast.on{opacity:1;transform:translateX(-50%) translateY(0)}#toast.success{background:#22c55e}#toast.error{background:#ef4444}
#login{position:fixed;inset:0;background:var(--gradient);display:flex;align-items:center;justify-content:center;padding:24px;z-index:1000}#login.hide{display:none}.login-wrap{text-align:center;max-width:380px;width:100%}.login-logo h1{font-size:32px;font-weight:800;color:#fff;margin-bottom:4px}.login-logo h1 span{color:#fbbf24}.login-logo p{color:rgba(255,255,255,.85);font-size:14px;margin-bottom:32px}.login-card{background:#fff;border-radius:28px;padding:36px 28px;box-shadow:0 25px 80px rgba(0,0,0,.15)}.login-card h2{font-size:22px;font-weight:700;color:var(--dark);margin-bottom:8px}.login-card>p{color:#64748b;margin-bottom:28px;font-size:14px}.pin-row{display:flex;gap:12px;justify-content:center;margin-bottom:20px}.pin-box{width:54px;height:62px;border:3px solid #e2e8f0;border-radius:14px;font-size:24px;font-weight:700;text-align:center;background:#f8fafc;color:var(--dark)}.pin-box:focus{outline:none;border-color:var(--primary)}#loginErr{background:#fef2f2;color:#dc2626;padding:12px;border-radius:10px;margin-bottom:16px;display:none;font-size:13px}#loginErr.on{display:block}
#app{display:none;min-height:100%}#app.on{display:block}
.topnav{display:none;position:fixed;top:0;left:0;right:0;height:68px;background:var(--glass);backdrop-filter:blur(20px);border-bottom:1px solid rgba(13,148,136,.1);padding:0 24px;align-items:center;z-index:100}.topnav-logo{display:flex;align-items:center;gap:10px;font-size:18px;font-weight:800;color:var(--dark)}.topnav-logo span{color:var(--accent)}.topnav-logo .icon{width:42px;height:42px;background:var(--gradient);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:20px;color:#fff}.topnav-menu{display:flex;gap:4px;margin-left:28px}.topnav-link{padding:8px 12px;border-radius:10px;font-size:11px;font-weight:600;color:#64748b;cursor:pointer;border:none;background:none;position:relative}.topnav-link.on{background:var(--primary);color:#fff}.topnav-badge{position:absolute;top:-2px;right:-2px;min-width:18px;height:18px;background:var(--danger);border-radius:9px;font-size:10px;font-weight:700;color:#fff;display:flex;align-items:center;justify-content:center}.topnav-right{margin-left:auto;display:flex;align-items:center;gap:14px}.topnav-user{display:flex;align-items:center;gap:10px;padding:8px 14px 8px 8px;background:rgba(13,148,136,.08);border-radius:50px;font-size:13px;font-weight:600}.topnav-avatar{width:34px;height:34px;background:var(--gradient);border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700}.topnav-logout{padding:10px 18px;background:rgba(239,68,68,.1);border-radius:50px;font-size:12px;font-weight:600;color:var(--danger);cursor:pointer;border:none}.adm{display:none!important}body.is-admin .adm{display:flex!important}
.mobhead{display:flex;position:fixed;top:0;left:0;right:0;height:calc(64px + var(--safe-top));padding-top:var(--safe-top);background:var(--glass);backdrop-filter:blur(20px);padding-left:16px;padding-right:16px;align-items:center;gap:10px;z-index:100}.mobhead-logo{display:flex;align-items:center;gap:10px;font-size:17px;font-weight:800;color:var(--dark);flex:1}.mobhead-logo span{color:var(--accent)}.mobhead-logo .icon{width:38px;height:38px;background:var(--gradient);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;color:#fff}.mobhead-btn{width:42px;height:42px;border-radius:12px;background:rgba(13,148,136,.08);display:flex;align-items:center;justify-content:center;font-size:18px;border:none;cursor:pointer;position:relative}.mobhead-badge{position:absolute;top:2px;right:2px;min-width:18px;height:18px;background:var(--danger);border-radius:9px;font-size:10px;font-weight:700;color:#fff;display:flex;align-items:center;justify-content:center}
.mobnav{display:flex;position:fixed;bottom:0;left:0;right:0;background:var(--glass);backdrop-filter:blur(20px);padding:10px 16px calc(10px + var(--safe-bottom));z-index:100}.mobnav-btn{flex:1;display:flex;flex-direction:column;align-items:center;gap:3px;padding:8px;border-radius:12px;font-size:10px;font-weight:600;color:#94a3b8;border:none;background:none;cursor:pointer;position:relative}.mobnav-btn span{font-size:22px}.mobnav-btn.on{color:var(--primary);background:rgba(13,148,136,.1)}.mobnav-badge{position:absolute;top:2px;right:50%;transform:translateX(14px);min-width:16px;height:16px;background:var(--danger);border-radius:8px;font-size:9px;font-weight:700;color:#fff;display:flex;align-items:center;justify-content:center}
.cart-float{position:fixed;bottom:calc(90px + var(--safe-bottom));right:16px;width:60px;height:60px;background:var(--gradient);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:26px;color:#fff;z-index:99;box-shadow:0 8px 30px rgba(13,148,136,.4);cursor:pointer;border:none}.cart-float-badge{position:absolute;top:-4px;right:-4px;min-width:24px;height:24px;background:var(--accent);border-radius:12px;font-size:12px;font-weight:700;color:#fff;display:flex;align-items:center;justify-content:center;border:3px solid #fff}
#menuBg{position:fixed;inset:0;background:rgba(19,78,74,.5);z-index:200;opacity:0;pointer-events:none;transition:.3s;backdrop-filter:blur(4px)}#menuBg.on{opacity:1;pointer-events:auto}#menuDrawer{position:fixed;top:0;right:0;bottom:0;width:300px;max-width:85%;background:#fff;z-index:201;transform:translateX(100%);transition:.3s;display:flex;flex-direction:column}#menuDrawer.on{transform:translateX(0)}.drawer-head{display:flex;align-items:center;justify-content:space-between;padding:20px;padding-top:calc(20px + var(--safe-top));border-bottom:1px solid #f1f5f9}.drawer-close{width:40px;height:40px;background:#f1f5f9;border-radius:12px;font-size:20px;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center}.drawer-body{flex:1;overflow-y:auto;padding:20px}.drawer-user{background:var(--gradient);border-radius:20px;padding:24px;text-align:center;margin-bottom:20px;color:#fff}.drawer-avatar{width:64px;height:64px;background:rgba(255,255,255,.2);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:26px;font-weight:700;margin:0 auto 12px}.drawer-badge{display:inline-block;padding:6px 14px;background:rgba(255,255,255,.2);border-radius:50px;font-size:11px;font-weight:700;margin-top:8px}.drawer-nav{display:flex;flex-direction:column;gap:6px}.drawer-link{display:flex;align-items:center;gap:12px;padding:14px 16px;border-radius:14px;font-size:14px;font-weight:600;color:#64748b;border:none;background:none;cursor:pointer;text-align:left;width:100%;position:relative}.drawer-link span{font-size:20px;width:26px}.drawer-link.on{background:var(--primary);color:#fff}.drawer-link-badge{position:absolute;right:16px;min-width:24px;height:24px;background:var(--danger);border-radius:12px;font-size:11px;font-weight:700;color:#fff;display:flex;align-items:center;justify-content:center}.drawer-foot{padding:20px;padding-bottom:calc(20px + var(--safe-bottom));border-top:1px solid #f1f5f9}.drawer-logout{width:100%;padding:16px;background:rgba(239,68,68,.1);border-radius:14px;font-size:15px;font-weight:600;color:var(--danger);border:none;cursor:pointer}
.main{padding-top:calc(64px + var(--safe-top));padding-bottom:calc(85px + var(--safe-bottom));min-height:100%}.container{padding:20px 16px;max-width:1400px;margin:0 auto}
.pg{display:none}.pg.on{display:block;animation:fadeIn .35s}@keyframes fadeIn{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}.pg-head{margin-bottom:24px}.pg-head-row{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px;margin-bottom:24px}.pg-title{font-size:24px;font-weight:800;margin-bottom:4px}.pg-sub{font-size:13px;color:#64748b}
.card{background:#fff;border-radius:20px;padding:20px;margin-bottom:16px;box-shadow:var(--shadow)}.card-title{font-size:16px;font-weight:700;margin-bottom:16px}
.stats{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-bottom:24px}.stat{background:#fff;border-radius:18px;padding:20px;box-shadow:var(--shadow);position:relative;overflow:hidden}.stat::before{content:'';position:absolute;top:0;left:0;right:0;height:4px;background:var(--gradient)}.stat-icon{font-size:32px;margin-bottom:12px}.stat-label{font-size:11px;font-weight:600;color:#94a3b8;text-transform:uppercase}.stat-value{font-size:22px;font-weight:800;margin-top:4px}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;height:44px;padding:0 18px;border-radius:12px;font-size:13px;font-weight:600;border:none;cursor:pointer}.btn-primary{background:var(--gradient);color:#fff}.btn-success{background:var(--success);color:#fff}.btn-danger{background:var(--danger);color:#fff}.btn-warning{background:var(--warning);color:#fff}.btn-ghost{background:rgba(13,148,136,.08)}.btn-sm{height:38px;padding:0 14px;font-size:12px;border-radius:10px}.btn-full{width:100%}
.field{margin-bottom:16px}.field-label{display:block;font-size:12px;font-weight:600;color:#64748b;margin-bottom:8px}.field-input{width:100%;height:48px;padding:0 16px;background:#f8fafc;border:2px solid #e2e8f0;border-radius:12px;font-size:15px;font-family:inherit}.field-input:focus{outline:none;border-color:var(--primary)}textarea.field-input{height:80px;padding:14px;resize:none}.field-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.badge{display:inline-block;padding:5px 10px;border-radius:8px;font-size:10px;font-weight:700;text-transform:uppercase}.badge-success{background:rgba(34,197,94,.12);color:var(--success)}.badge-warning{background:rgba(245,158,11,.12);color:var(--warning)}.badge-danger{background:rgba(239,68,68,.12);color:var(--danger)}.badge-primary{background:rgba(13,148,136,.12);color:var(--primary)}
.action-btns{display:flex;gap:8px}
.hero{background:var(--gradient);border-radius:20px;padding:24px;color:#fff;margin-bottom:20px}.hero.danger{background:#ef4444}.hero.success{background:#22c55e}.hero small{font-size:14px;opacity:.9}.hero strong{display:block;font-size:32px;font-weight:800;margin-top:6px}
.products{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}.product{background:#fff;border-radius:16px;padding:14px;cursor:pointer;box-shadow:var(--shadow);border:2px solid transparent}.product:active{border-color:var(--primary)}.product.out{opacity:.4;pointer-events:none}.product-img{width:100%;height:80px;background:linear-gradient(135deg,#f0fdfa,#ccfbf1);border-radius:12px;margin-bottom:10px;display:flex;align-items:center;justify-content:center;font-size:36px;overflow:hidden}.product-img img{width:100%;height:100%;object-fit:cover}.product-name{font-size:13px;font-weight:600;margin-bottom:6px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.product-price{font-size:18px;font-weight:800;color:var(--primary)}.product-stock{display:inline-flex;padding:4px 10px;border-radius:50px;font-size:10px;font-weight:700;margin-top:6px}.product-stock.ok{background:rgba(34,197,94,.12);color:var(--success)}.product-stock.low{background:rgba(245,158,11,.12);color:var(--warning)}.product-stock.out{background:rgba(239,68,68,.12);color:var(--danger)}
.cat-filter{display:flex;gap:8px;overflow-x:auto;margin-bottom:16px;padding-bottom:6px}.cat-chip{height:36px;padding:0 16px;background:#fff;border:2px solid #e2e8f0;border-radius:50px;font-size:12px;font-weight:600;color:#64748b;white-space:nowrap;cursor:pointer;display:flex;align-items:center;flex-shrink:0}.cat-chip.on{background:var(--primary);color:#fff;border-color:transparent}
.modes{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:20px}.mode{height:70px;background:#fff;border:3px solid #e2e8f0;border-radius:16px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;font-size:11px;font-weight:700;color:#94a3b8;cursor:pointer}.mode span{font-size:26px}.mode.on{border-color:var(--primary);color:var(--primary)}.mode.wh.on{border-color:var(--warning);color:var(--warning)}.mode.bu.on{border-color:#8b5cf6;color:#8b5cf6}
.search-box{position:relative;margin-bottom:18px}.search-box input{padding-left:48px;height:52px;border-radius:16px}.search-box::before{content:'ğŸ”';position:absolute;left:16px;top:50%;transform:translateY(-50%);font-size:18px}
#cartBg{position:fixed;inset:0;background:rgba(19,78,74,.5);z-index:300;opacity:0;pointer-events:none;transition:.3s}#cartBg.on{opacity:1;pointer-events:auto}#cartDrawer{position:fixed;bottom:0;left:0;right:0;background:#fff;border-radius:28px 28px 0 0;max-height:90vh;z-index:301;transform:translateY(100%);transition:.35s;display:flex;flex-direction:column}#cartDrawer.on{transform:translateY(0)}.cart-bar{width:48px;height:5px;background:#e2e8f0;border-radius:3px;margin:14px auto}.cart-head{display:flex;align-items:center;justify-content:space-between;padding:0 20px 16px;border-bottom:1px solid #f1f5f9}.cart-head h3{font-size:18px;font-weight:800}.cart-count{background:var(--gradient);color:#fff;padding:6px 14px;border-radius:50px;font-size:13px;font-weight:700}.cart-body{flex:1;overflow-y:auto;padding:16px 20px;max-height:35vh}.cart-item{display:flex;align-items:center;gap:10px;padding:12px;background:#f8fafc;border-radius:14px;margin-bottom:8px}.cart-item-img{width:46px;height:46px;background:linear-gradient(135deg,#f0fdfa,#ccfbf1);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px;overflow:hidden;flex-shrink:0}.cart-item-img img{width:100%;height:100%;object-fit:cover}.cart-item-info{flex:1;min-width:0}.cart-item-name{font-size:13px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.cart-item-price{font-size:11px;color:#64748b}.cart-qty{display:flex;align-items:center;gap:6px}.cart-qty-btn{width:32px;height:32px;border-radius:10px;background:#fff;border:2px solid #e2e8f0;font-size:16px;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center}.cart-qty-num{font-size:14px;font-weight:700;min-width:22px;text-align:center}.cart-item-total{font-size:14px;font-weight:700;color:var(--primary)}.cart-item-del{width:32px;height:32px;border-radius:10px;background:rgba(239,68,68,.1);color:var(--danger);font-size:14px;display:flex;align-items:center;justify-content:center;border:none;cursor:pointer;flex-shrink:0}.cart-empty{text-align:center;padding:40px;color:#94a3b8}.cart-empty span{font-size:56px;display:block;margin-bottom:12px;opacity:.3}.cart-foot{padding:16px 20px;padding-bottom:calc(16px + var(--safe-bottom));border-top:1px solid #f1f5f9;background:#fafafa}.cart-summary{margin-bottom:14px}.cart-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;font-size:13px;color:#64748b}.cart-row b{color:var(--dark)}.cart-row.total{font-size:18px;font-weight:800;padding-top:12px;border-top:2px dashed #e2e8f0}.cart-row.total b{color:var(--primary)}.disc-input{width:70px;height:34px;padding:0 10px;background:#fff;border:2px solid #e2e8f0;border-radius:8px;font-size:13px;font-weight:600;text-align:right}.cust-btn{width:100%;height:42px;background:rgba(13,148,136,.06);border:2px dashed rgba(13,148,136,.3);border-radius:12px;font-size:13px;font-weight:600;color:var(--primary);cursor:pointer;margin-bottom:12px;display:flex;align-items:center;justify-content:center;gap:8px}.cust-btn.selected{background:rgba(13,148,136,.1);border-style:solid}.checkout-btn{width:100%;height:54px;background:var(--gradient);border-radius:14px;color:#fff;font-size:16px;font-weight:700;border:none;cursor:pointer;box-shadow:0 6px 20px rgba(13,148,136,.3)}.checkout-btn:disabled{opacity:.5}
.modal{position:fixed;inset:0;z-index:400;display:none;align-items:flex-end;justify-content:center}.modal.on{display:flex}.modal-bg{position:absolute;inset:0;background:rgba(19,78,74,.5);backdrop-filter:blur(4px)}.modal-box{position:relative;background:#fff;border-radius:28px 28px 0 0;width:100%;max-height:88vh;display:flex;flex-direction:column;animation:slideUp .35s}@keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}.modal-head{display:flex;align-items:center;justify-content:space-between;padding:20px;border-bottom:1px solid #f1f5f9}.modal-head h3{font-size:18px;font-weight:700}.modal-close{width:40px;height:40px;background:#f1f5f9;border-radius:12px;font-size:20px;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center}.modal-body{flex:1;overflow-y:auto;padding:20px}.modal-foot{padding:16px 20px calc(16px + var(--safe-bottom));border-top:1px solid #f1f5f9;display:flex;gap:10px}
.tbl-wrap{overflow-x:auto;margin:-20px;margin-top:0;padding:0 20px 20px}table{width:100%;border-collapse:collapse;min-width:400px}th{text-align:left;padding:12px 10px;background:#f8fafc;font-size:10px;font-weight:700;color:#64748b;text-transform:uppercase}td{padding:12px 10px;border-bottom:1px solid #f1f5f9;font-size:13px}.tbl-empty{text-align:center;padding:40px;color:#94a3b8}.tbl-empty span{font-size:48px;display:block;margin-bottom:12px;opacity:.3}
.tabs{display:flex;gap:8px;overflow-x:auto;margin-bottom:20px}.tab{height:40px;padding:0 18px;background:#fff;border:2px solid #e2e8f0;border-radius:12px;font-size:13px;font-weight:600;color:#64748b;white-space:nowrap;cursor:pointer}.tab.on{background:var(--primary);color:#fff;border-color:transparent}
.report-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}.report-card{background:#fff;border-radius:18px;padding:20px;box-shadow:var(--shadow)}.report-card h4{font-size:11px;font-weight:600;color:#64748b;margin-bottom:6px;text-transform:uppercase}.report-card .value{font-size:22px;font-weight:800}.report-card .value.success{color:var(--success)}.report-card .value.danger{color:var(--danger)}
.top-product{display:flex;align-items:center;gap:12px;padding:14px;background:#f8fafc;border-radius:14px;margin-bottom:8px}.top-product-rank{width:28px;height:28px;background:var(--gradient);color:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:12px}.top-product-info{flex:1}.top-product-name{font-weight:600;font-size:14px}.top-product-qty{font-size:12px;color:#64748b}.top-product-total{font-weight:700;color:var(--primary)}
.expense-item{display:flex;align-items:center;gap:14px;padding:14px;background:#f8fafc;border-radius:14px;margin-bottom:8px}.expense-icon{width:44px;height:44px;background:rgba(239,68,68,.1);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:22px}.expense-info{flex:1}.expense-title{font-weight:600}.expense-date{font-size:12px;color:#64748b}.expense-amount{font-weight:700;color:var(--danger)}
.customer-item{background:#fff;border-radius:16px;padding:16px;box-shadow:var(--shadow);margin-bottom:12px;display:flex;align-items:center;gap:14px;cursor:pointer;border:2px solid transparent}.customer-avatar{width:50px;height:50px;background:var(--gradient);border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;font-size:20px;font-weight:700;flex-shrink:0}.customer-info{flex:1;min-width:0}.customer-name{font-size:16px;font-weight:700;margin-bottom:2px}.customer-phone{font-size:13px;color:#64748b}.customer-stats{display:flex;gap:16px;margin-top:8px}.customer-stat-value{font-size:14px;font-weight:700;color:var(--primary)}.customer-stat-label{font-size:10px;color:#94a3b8}
.stock-item{display:flex;align-items:center;gap:10px;padding:14px;background:#f8fafc;border-radius:14px;margin-bottom:8px;border-left:4px solid #e2e8f0}.stock-item.counted{border-left-color:var(--success)}.stock-item.pos{border-left-color:var(--success)}.stock-item.neg{border-left-color:var(--danger)}.stock-item-info{flex:1;min-width:0}.stock-item-name{font-weight:600;font-size:14px;margin-bottom:2px}.stock-qty{display:flex;flex-direction:column;align-items:center;min-width:55px}.stock-qty-label{font-size:9px;color:#94a3b8;text-transform:uppercase}.stock-qty-value{font-size:18px;font-weight:700}.stock-qty-input{width:65px;height:40px;text-align:center;font-size:16px;font-weight:700;border:2px solid #e2e8f0;border-radius:10px}.stock-qty-input:focus{outline:none;border-color:var(--primary)}.stock-variance{min-width:48px;text-align:center;font-weight:700;padding:6px;border-radius:8px;font-size:13px}.stock-variance.pos{background:rgba(34,197,94,.12);color:var(--success)}.stock-variance.neg{background:rgba(239,68,68,.12);color:var(--danger)}.stock-variance.zero{background:#f1f5f9;color:#64748b}
.stock-summary{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:20px}.stock-summary-card{background:#fff;border-radius:14px;padding:16px;text-align:center;box-shadow:var(--shadow)}.stock-summary-value{font-size:24px;font-weight:800}.stock-summary-label{font-size:11px;color:#64748b;margin-top:4px}
.stock-progress{height:8px;background:#e2e8f0;border-radius:4px;overflow:hidden;margin:16px 0}.stock-progress-bar{height:100%;background:var(--gradient);border-radius:4px}
.order-card{background:#fff;border-radius:18px;padding:18px;box-shadow:var(--shadow);margin-bottom:12px;border-left:4px solid var(--primary)}.order-card.completed{border-left-color:var(--success);opacity:.7}.order-card.cancelled{border-left-color:var(--danger);opacity:.5}.order-head{display:flex;justify-content:space-between;margin-bottom:10px}.order-id{font-size:15px;font-weight:700}.order-time{font-size:12px;color:#94a3b8}.order-status{padding:5px 12px;border-radius:50px;font-size:11px;font-weight:700}.order-status.pending{background:rgba(13,148,136,.12);color:var(--primary)}.order-status.completed{background:rgba(34,197,94,.12);color:var(--success)}.order-status.cancelled{background:rgba(239,68,68,.12);color:var(--danger)}.order-customer{display:flex;align-items:center;gap:12px;padding:12px;background:#f8fafc;border-radius:12px;margin-bottom:12px}.order-avatar{width:42px;height:42px;background:var(--gradient);border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;font-size:18px}.order-info h4{font-size:14px;font-weight:600}.order-info p{font-size:12px;color:#64748b}.order-item{display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px dashed #e2e8f0;font-size:13px}.order-item:last-child{border-bottom:none}.order-footer{display:flex;justify-content:space-between;align-items:center;padding-top:12px;border-top:2px solid #f1f5f9;flex-wrap:wrap;gap:10px}.order-total{font-size:20px;font-weight:800;color:var(--primary)}
.img-upload{width:100%;height:110px;background:linear-gradient(135deg,#f0fdfa,#ccfbf1);border:2px dashed rgba(13,148,136,.3);border-radius:14px;display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;overflow:hidden;position:relative}.img-upload img{width:100%;height:100%;object-fit:cover}.img-upload span{font-size:36px;margin-bottom:6px}.img-upload p{font-size:12px;color:#64748b}.img-upload input{position:absolute;inset:0;opacity:0;cursor:pointer}
.realtime-dot{width:8px;height:8px;background:var(--success);border-radius:50%;display:inline-block;margin-right:6px;animation:pulse 2s infinite}@keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
@media(min-width:768px){.mobhead,.mobnav{display:none}#menuBg,#menuDrawer{display:none!important}.topnav{display:flex}.main{padding-top:68px;padding-bottom:32px}.container{padding:28px 40px}.cart-float{bottom:32px;right:32px}.stats{grid-template-columns:repeat(4,1fr)}.products{grid-template-columns:repeat(3,1fr)}.modal{align-items:center;padding:32px}.modal-box{border-radius:24px;max-width:480px}#cartDrawer{max-width:420px;right:0;left:auto;border-radius:28px 0 0 28px;max-height:100vh}.report-grid{grid-template-columns:repeat(4,1fr)}}
@media(min-width:1024px){.products{grid-template-columns:repeat(4,1fr)}}
@media print{@page{size:80mm auto;margin:0}body *{visibility:hidden}#printArea,#printArea *{visibility:visible}#printArea{position:fixed;left:0;top:0;width:80mm;padding:3mm;background:#fff!important;font-family:'Courier New',monospace;font-size:12px;line-height:1.4}}
</style>
</head>
<body>
<div id="loader" class="on"><div class="brand">Everytin <span>Room</span></div><div class="spin"></div><p id="loaderText">Loading...</p></div>
<div id="toast"></div>
<div id="login"><div class="login-wrap"><div class="login-logo"><h1>Everytin <span>Room</span></h1><p>Your One Stop Shop</p></div><div class="login-card"><h2>Welcome Back!</h2><p>Enter your 4-digit PIN</p><div id="loginErr">Invalid PIN</div><div class="pin-row"><input type="tel" maxlength="1" class="pin-box" id="p1" oninput="pinInput(1)" inputmode="numeric"><input type="tel" maxlength="1" class="pin-box" id="p2" oninput="pinInput(2)" inputmode="numeric"><input type="tel" maxlength="1" class="pin-box" id="p3" oninput="pinInput(3)" inputmode="numeric"><input type="tel" maxlength="1" class="pin-box" id="p4" oninput="pinInput(4)" inputmode="numeric"></div></div></div></div>
<div id="app">
<nav class="topnav"><div class="topnav-logo"><div class="icon">ğŸ›’</div>Everytin <span>Room</span></div><div class="topnav-menu"><button class="topnav-link adm on" data-pg="dash" onclick="goTo('dash')">ğŸ“Š Dash</button><button class="topnav-link" data-pg="orders" onclick="goTo('orders')">ğŸ›ï¸ Orders<span class="topnav-badge" id="orderBadgeTop">0</span></button><button class="topnav-link" data-pg="pos" onclick="goTo('pos')">ğŸ›’ POS</button><button class="topnav-link" data-pg="receipts" onclick="goTo('receipts')">ğŸ§¾ Receipts</button><button class="topnav-link adm" data-pg="products" onclick="goTo('products')">ğŸ“¦ Products</button><button class="topnav-link adm" data-pg="bundles" onclick="goTo('bundles')">ğŸ Bundles</button><button class="topnav-link adm" data-pg="customers" onclick="goTo('customers')">ğŸ‘¥ Customers</button><button class="topnav-link adm" data-pg="stock" onclick="goTo('stock')">ğŸ“‹ Stock</button><button class="topnav-link adm" data-pg="expenses" onclick="goTo('expenses')">ğŸ’¸ Expenses</button><button class="topnav-link adm" data-pg="reports" onclick="goTo('reports')">ğŸ“ˆ Reports</button><button class="topnav-link adm" data-pg="staff" onclick="goTo('staff')">ğŸ‘¤ Staff</button></div><div class="topnav-right"><span class="realtime-dot"></span><div class="topnav-user"><div class="topnav-avatar" id="topAv">A</div><span id="topNm">Admin</span></div><button class="topnav-logout" onclick="logout()">Sign Out</button></div></nav>
<header class="mobhead"><div class="mobhead-logo"><div class="icon">ğŸ›’</div>Everytin <span>Room</span></div><button class="mobhead-btn" onclick="goTo('orders')">ğŸ›ï¸<span class="mobhead-badge" id="orderBadgeMob">0</span></button><button class="mobhead-btn" onclick="openMenu()">â˜°</button></header>
<button class="cart-float" onclick="openCart()">ğŸ›’<span class="cart-float-badge" id="cartBadge">0</span></button>
<div id="menuBg" onclick="closeMenu()"></div>
<div id="menuDrawer"><div class="drawer-head"><h3>Menu</h3><button class="drawer-close" onclick="closeMenu()">âœ•</button></div><div class="drawer-body"><div class="drawer-user"><div class="drawer-avatar" id="drAv">A</div><h4 id="drNm">Admin</h4><span class="drawer-badge" id="drBg">ADMIN</span></div><nav class="drawer-nav"><button class="drawer-link adm on" data-pg="dash" onclick="goTo('dash')"><span>ğŸ“Š</span>Dashboard</button><button class="drawer-link" data-pg="orders" onclick="goTo('orders')"><span>ğŸ›ï¸</span>Orders<span class="drawer-link-badge" id="orderBadgeDr">0</span></button><button class="drawer-link" data-pg="pos" onclick="goTo('pos')"><span>ğŸ›’</span>POS</button><button class="drawer-link" data-pg="receipts" onclick="goTo('receipts')"><span>ğŸ§¾</span>Receipts</button><button class="drawer-link adm" data-pg="products" onclick="goTo('products')"><span>ğŸ“¦</span>Products</button><button class="drawer-link adm" data-pg="bundles" onclick="goTo('bundles')"><span>ğŸ</span>Bundles</button><button class="drawer-link adm" data-pg="customers" onclick="goTo('customers')"><span>ğŸ‘¥</span>Customers</button><button class="drawer-link adm" data-pg="stock" onclick="goTo('stock')"><span>ğŸ“‹</span>Stock Take</button><button class="drawer-link adm" data-pg="expenses" onclick="goTo('expenses')"><span>ğŸ’¸</span>Expenses</button><button class="drawer-link adm" data-pg="reports" onclick="goTo('reports')"><span>ğŸ“ˆ</span>Reports</button><button class="drawer-link adm" data-pg="staff" onclick="goTo('staff')"><span>ğŸ‘¤</span>Staff</button></nav></div><div class="drawer-foot"><button class="drawer-logout" onclick="logout()">ğŸšª Sign Out</button></div></div>
<nav class="mobnav"><button class="mobnav-btn" data-pg="orders" onclick="goTo('orders')"><span>ğŸ›ï¸</span>Orders<span class="mobnav-badge" id="orderBadgeNav">0</span></button><button class="mobnav-btn" data-pg="pos" onclick="goTo('pos')"><span>ğŸ›’</span>POS</button><button class="mobnav-btn" data-pg="receipts" onclick="goTo('receipts')"><span>ğŸ§¾</span>Receipts</button><button class="mobnav-btn adm" data-pg="dash" onclick="goTo('dash')"><span>ğŸ“Š</span>More</button></nav>
<main class="main"><div class="container">
<section class="pg on" id="pgDash"><div class="pg-head"><h1 class="pg-title">ğŸ“Š Dashboard</h1><p class="pg-sub"><span class="realtime-dot"></span>Live</p></div><div class="stats"><div class="stat"><div class="stat-icon">ğŸ’°</div><div class="stat-label">Today Sales</div><div class="stat-value" id="dToday">GHS 0</div></div><div class="stat"><div class="stat-icon">ğŸ’µ</div><div class="stat-label">Profit</div><div class="stat-value" id="dProfit">GHS 0</div></div><div class="stat"><div class="stat-icon">ğŸ›ï¸</div><div class="stat-label">Pending</div><div class="stat-value" id="dPending">0</div></div><div class="stat"><div class="stat-icon">ğŸ’¸</div><div class="stat-label">Expenses</div><div class="stat-value" id="dExpenses">GHS 0</div></div></div><div class="card"><div class="card-title">ğŸ† Top Selling</div><div id="topProductsToday"></div></div></section>
<section class="pg" id="pgOrders"><div class="pg-head-row"><div><h1 class="pg-title">ğŸ›ï¸ Orders</h1></div><button class="btn btn-primary" onclick="loadOrders()">ğŸ”„</button></div><div class="hero"><small>Pending</small><strong id="orderPendingCount">0</strong></div><div class="tabs"><button class="tab on" onclick="setOrderFilter('pending')">Pending</button><button class="tab" onclick="setOrderFilter('completed')">Done</button><button class="tab" onclick="setOrderFilter('all')">All</button></div><div id="ordersList"></div></section>
<section class="pg" id="pgPos"><div class="pg-head"><h1 class="pg-title">ğŸ›’ POS</h1></div><div class="search-box"><input type="text" class="field-input" placeholder="Search..." id="posQ" oninput="renderPOS()"></div><div class="cat-filter" id="catFilter"></div><div class="modes"><button class="mode on" id="mdRet" onclick="setMode('retail')"><span>ğŸ›ï¸</span>Retail</button><button class="mode wh" id="mdWho" onclick="setMode('wholesale')"><span>ğŸ­</span>Wholesale</button><button class="mode bu" id="mdBun" onclick="setMode('bundle')"><span>ğŸ</span>Bundle</button></div><div class="products" id="prodGrid"></div></section>
<section class="pg" id="pgReceipts"><div class="pg-head"><h1 class="pg-title">ğŸ§¾ Receipts</h1></div><div class="card"><input type="text" class="field-input" placeholder="ğŸ” Search..." id="rcQ" oninput="renderReceipts()" style="margin-bottom:16px"><div class="tbl-wrap"><table><thead><tr><th>Receipt</th><th>Date</th><th>Customer</th><th>Total</th><th></th></tr></thead><tbody id="rcTbl"></tbody></table></div></div></section>
<section class="pg" id="pgProducts"><div class="pg-head-row"><div><h1 class="pg-title">ğŸ“¦ Products</h1></div><button class="btn btn-primary" onclick="openProductModal()">â•</button></div><div class="card"><input type="text" class="field-input" placeholder="ğŸ”" id="prQ" oninput="renderProducts()" style="margin-bottom:16px"><div class="tbl-wrap"><table><thead><tr><th></th><th>Name</th><th>Price</th><th>Stock</th><th></th></tr></thead><tbody id="prTbl"></tbody></table></div></div></section>
<section class="pg" id="pgBundles"><div class="pg-head-row"><div><h1 class="pg-title">ğŸ Bundles</h1></div><button class="btn btn-primary" onclick="openBundleModal()">â•</button></div><div id="bundlesList"></div></section>
<section class="pg" id="pgCustomers"><div class="pg-head-row"><div><h1 class="pg-title">ğŸ‘¥ Customers</h1></div><button class="btn btn-primary" onclick="openCustomerModal()">â•</button></div><div class="stats" style="grid-template-columns:repeat(3,1fr)"><div class="stat"><div class="stat-icon">ğŸ‘¥</div><div class="stat-label">Total</div><div class="stat-value" id="custTotal">0</div></div><div class="stat"><div class="stat-icon">â­</div><div class="stat-label">Points</div><div class="stat-value" id="custPoints">0</div></div><div class="stat"><div class="stat-icon">ğŸ’°</div><div class="stat-label">Revenue</div><div class="stat-value" id="custRevenue">GHS 0</div></div></div><div class="card"><input type="text" class="field-input" placeholder="ğŸ” Phone..." id="custQ" oninput="renderCustomers()" style="margin-bottom:16px"><div id="customersList"></div></div></section>
<section class="pg" id="pgStock"><div class="pg-head-row"><div><h1 class="pg-title">ğŸ“‹ Stock Take</h1></div><div class="action-btns"><button class="btn btn-ghost" onclick="viewStockHistory()">ğŸ“œ</button><button class="btn btn-primary" onclick="startNewStockTake()">â•</button></div></div><div id="stockTakeArea"></div></section>
<section class="pg" id="pgExpenses"><div class="pg-head-row"><div><h1 class="pg-title">ğŸ’¸ Expenses</h1></div><button class="btn btn-danger" onclick="openExpenseModal()">â•</button></div><div class="hero danger"><small>This Month</small><strong id="expMonthTotal">GHS 0</strong></div><div class="card"><div id="expensesList"></div></div></section>
<section class="pg" id="pgReports"><div class="pg-head"><h1 class="pg-title">ğŸ“ˆ Reports</h1></div><div class="field-row" style="margin-bottom:20px"><div class="field"><label class="field-label">From</label><input type="date" class="field-input" id="repFrom" onchange="renderReports()"></div><div class="field"><label class="field-label">To</label><input type="date" class="field-input" id="repTo" onchange="renderReports()"></div></div><div class="report-grid"><div class="report-card"><h4>Sales</h4><div class="value" id="repSales">GHS 0</div></div><div class="report-card"><h4>Profit</h4><div class="value success" id="repProfit">GHS 0</div></div><div class="report-card"><h4>Expenses</h4><div class="value danger" id="repExpenses">GHS 0</div></div><div class="report-card"><h4>Net</h4><div class="value" id="repNet">GHS 0</div></div></div><div class="card" style="margin-top:16px"><div class="card-title">ğŸ† Top Products</div><div id="topProductsList"></div></div></section>
<section class="pg" id="pgStaff"><div class="pg-head-row"><div><h1 class="pg-title">ğŸ‘¤ Staff</h1></div><button class="btn btn-primary" onclick="openStaffModal()">â•</button></div><div class="card"><div class="tbl-wrap"><table><thead><tr><th>Name</th><th>Role</th><th>Status</th><th></th></tr></thead><tbody id="sfTbl"></tbody></table></div></div></section>
</div></main>
<div id="cartBg" onclick="closeCart()"></div>
<div id="cartDrawer"><div class="cart-bar"></div><div class="cart-head"><h3>ğŸ›’ <span class="cart-count" id="cartCnt">0</span></h3><div class="action-btns"><button class="btn btn-warning btn-sm" onclick="holdCart()">â¸ï¸</button><button class="btn btn-ghost btn-sm" onclick="openHeldCarts()" id="heldBtn" style="display:none"><span id="heldCnt">0</span></button><button class="btn btn-danger btn-sm" onclick="clearCart()">ğŸ—‘ï¸</button></div></div><div class="cart-body" id="cartBody"><div class="cart-empty"><span>ğŸ›’</span><p>Empty</p></div></div><div class="cart-foot"><div class="cart-summary"><div class="cart-row"><span>Subtotal</span><b id="cartSub">GHS 0</b></div><div class="cart-row"><span>Discount</span><input type="number" class="disc-input" id="cartDisc" value="0" min="0" onchange="calcCart()"></div><div class="cart-row total"><span>Total</span><b id="cartTot">GHS 0</b></div></div><button class="cust-btn" id="custBtn" onclick="openSelectCustomer()">ğŸ‘¥ Customer</button><input type="hidden" id="cartCustId"><button class="checkout-btn" id="payBtn" onclick="openPayModal()" disabled>âœ“ Checkout</button></div></div>
</div>
<div class="modal" id="payModal"><div class="modal-bg" onclick="closeMod('payModal')"></div><div class="modal-box"><div class="modal-head"><h3>ğŸ’³ Payment</h3><button class="modal-close" onclick="closeMod('payModal')">âœ•</button></div><div class="modal-body"><div class="field"><label class="field-label">Method</label><select class="field-input" id="payMethod"><option value="cash">ğŸ’µ Cash</option><option value="momo">ğŸ“± MoMo</option><option value="card">ğŸ’³ Card</option></select></div><div class="hero" style="margin-top:16px"><small>Total</small><strong id="payTotal">GHS 0</strong></div></div><div class="modal-foot"><button class="btn btn-primary btn-full" onclick="completeSale()">âœ“ Confirm & Print</button></div></div></div>
<div class="modal" id="prModal"><div class="modal-bg" onclick="closeMod('prModal')"></div><div class="modal-box"><div class="modal-head"><h3 id="prModalTitle">Add Product</h3><button class="modal-close" onclick="closeMod('prModal')">âœ•</button></div><div class="modal-body"><input type="hidden" id="ePrId"><div class="field"><label class="field-label">Image</label><div class="img-upload" id="prImgUpload"><span>ğŸ“·</span><p>Upload</p><input type="file" id="prImgInput" accept="image/*" onchange="previewImg(this)"></div></div><input type="hidden" id="prImgUrl"><div class="field"><label class="field-label">Name</label><input type="text" class="field-input" id="prName"></div><div class="field"><label class="field-label">Category</label><input type="text" class="field-input" id="prCat"></div><div class="field-row"><div class="field"><label class="field-label">Cost</label><input type="number" class="field-input" id="prCost" min="0" step="0.01"></div><div class="field"><label class="field-label">Price</label><input type="number" class="field-input" id="prPrice" min="0" step="0.01"></div></div><div class="field-row"><div class="field"><label class="field-label">Wholesale</label><input type="number" class="field-input" id="prWhole" min="0" step="0.01"></div><div class="field"><label class="field-label">Stock</label><input type="number" class="field-input" id="prQty" min="0"></div></div></div><div class="modal-foot"><button class="btn btn-ghost" onclick="closeMod('prModal')">Cancel</button><button class="btn btn-primary" onclick="saveProduct()">ğŸ’¾ Save</button></div></div></div>
<div class="modal" id="bundleModal"><div class="modal-bg" onclick="closeMod('bundleModal')"></div><div class="modal-box"><div class="modal-head"><h3 id="bundleModalTitle">Bundle</h3><button class="modal-close" onclick="closeMod('bundleModal')">âœ•</button></div><div class="modal-body"><input type="hidden" id="eBundleId"><div class="field"><label class="field-label">Name</label><input type="text" class="field-input" id="bundleName"></div><div class="field"><label class="field-label">Price</label><input type="number" class="field-input" id="bundlePrice" min="0" step="0.01"></div><div class="field"><label class="field-label">Products</label><div id="bundleProds" style="max-height:180px;overflow-y:auto;background:#f8fafc;border-radius:12px;padding:12px"></div></div></div><div class="modal-foot"><button class="btn btn-ghost" onclick="closeMod('bundleModal')">Cancel</button><button class="btn btn-primary" onclick="saveBundle()">ğŸ’¾</button></div></div></div>
<div class="modal" id="custModal"><div class="modal-bg" onclick="closeMod('custModal')"></div><div class="modal-box"><div class="modal-head"><h3 id="custModalTitle">Customer</h3><button class="modal-close" onclick="closeMod('custModal')">âœ•</button></div><div class="modal-body"><input type="hidden" id="eCustId"><div class="field"><label class="field-label">Name</label><input type="text" class="field-input" id="custName"></div><div class="field"><label class="field-label">Phone</label><input type="tel" class="field-input" id="custPhone"></div><div class="field"><label class="field-label">Address</label><textarea class="field-input" id="custAddress"></textarea></div><div class="field"><label class="field-label">Notes</label><textarea class="field-input" id="custNotes"></textarea></div></div><div class="modal-foot"><button class="btn btn-ghost" onclick="closeMod('custModal')">Cancel</button><button class="btn btn-primary" onclick="saveCustomer()">ğŸ’¾</button></div></div></div>
<div class="modal" id="selectCustModal"><div class="modal-bg" onclick="closeMod('selectCustModal')"></div><div class="modal-box"><div class="modal-head"><h3>ğŸ‘¥ Customer</h3><button class="modal-close" onclick="closeMod('selectCustModal')">âœ•</button></div><div class="modal-body"><input type="tel" class="field-input" placeholder="ğŸ” Phone..." id="selectCustQ" oninput="renderSelectCust()" style="margin-bottom:14px"><div id="selectCustList"></div></div><div class="modal-foot"><button class="btn btn-ghost" onclick="clearSelectedCust()">Clear</button><button class="btn btn-primary" onclick="openCustomerModal();closeMod('selectCustModal')">â• New</button></div></div></div>
<div class="modal" id="expModal"><div class="modal-bg" onclick="closeMod('expModal')"></div><div class="modal-box"><div class="modal-head"><h3>ğŸ’¸ Expense</h3><button class="modal-close" onclick="closeMod('expModal')">âœ•</button></div><div class="modal-body"><div class="field"><label class="field-label">Title</label><input type="text" class="field-input" id="expTitle"></div><div class="field"><label class="field-label">Category</label><select class="field-input" id="expCat"><option value="utilities">âš¡ Utilities</option><option value="rent">ğŸ  Rent</option><option value="supplies">ğŸ“¦ Supplies</option><option value="transport">ğŸš— Transport</option><option value="salary">ğŸ‘¤ Salary</option><option value="other">ğŸ“ Other</option></select></div><div class="field"><label class="field-label">Amount</label><input type="number" class="field-input" id="expAmt" min="0" step="0.01"></div><div class="field"><label class="field-label">Notes</label><textarea class="field-input" id="expNotes"></textarea></div></div><div class="modal-foot"><button class="btn btn-ghost" onclick="closeMod('expModal')">Cancel</button><button class="btn btn-danger" onclick="saveExpense()">ğŸ’¾</button></div></div></div>
<div class="modal" id="sfModal"><div class="modal-bg" onclick="closeMod('sfModal')"></div><div class="modal-box"><div class="modal-head"><h3 id="sfModalTitle">Staff</h3><button class="modal-close" onclick="closeMod('sfModal')">âœ•</button></div><div class="modal-body"><input type="hidden" id="eSfId"><div class="field"><label class="field-label">Name</label><input type="text" class="field-input" id="sfName"></div><div class="field"><label class="field-label">Role</label><select class="field-input" id="sfRole"><option value="cashier">Cashier</option><option value="admin">Admin</option></select></div><div class="field"><label class="field-label">PIN</label><input type="tel" class="field-input" id="sfPin" maxlength="4" inputmode="numeric"></div></div><div class="modal-foot"><button class="btn btn-ghost" onclick="closeMod('sfModal')">Cancel</button><button class="btn btn-primary" onclick="saveStaff()">ğŸ’¾</button></div></div></div>
<div class="modal" id="heldModal"><div class="modal-bg" onclick="closeMod('heldModal')"></div><div class="modal-box"><div class="modal-head"><h3>ğŸ“‹ Held</h3><button class="modal-close" onclick="closeMod('heldModal')">âœ•</button></div><div class="modal-body" id="heldBody"></div></div></div>
<div class="modal" id="rcptModal"><div class="modal-bg" onclick="closeMod('rcptModal')"></div><div class="modal-box"><div class="modal-head"><h3>ğŸ§¾ Receipt</h3><button class="modal-close" onclick="closeMod('rcptModal')">âœ•</button></div><div class="modal-body" id="rcptBody"></div><div class="modal-foot"><button class="btn btn-ghost" onclick="closeMod('rcptModal')">Close</button><button class="btn btn-primary" onclick="printRcpt()">ğŸ–¨ï¸</button></div></div></div>
<div class="modal" id="stockHistModal"><div class="modal-bg" onclick="closeMod('stockHistModal')"></div><div class="modal-box"><div class="modal-head"><h3>ğŸ“œ History</h3><button class="modal-close" onclick="closeMod('stockHistModal')">âœ•</button></div><div class="modal-body" id="stockHistBody"></div></div></div>
<div id="printArea"></div>
 ${SHOP_INFO.phone2}<br>${SHOP_INFO.address}<br>${SHOP_INFO.website}</div></div><div style="border-top:1px dashed #ccc;margin:12px 0"></div><div style="display:flex;justify-content:space-between;margin:4px 0;font-size:11px"><span>Receipt:</span><span>${s.receipt_no}</span></div><div style="display:flex;justify-content:space-between;margin:4px 0;font-size:11px"><span>Date:</span><span>${fmtDT(s.created_at)}</span></div>${s.customer_name?`<div style="display:flex;justify-content:space-between;margin:4px 0;font-size:11px"><span>Customer:</span><span>${s.customer_name}</span></div>`:''}${s.customer_phone?`<div style="display:flex;justify-content:space-between;margin:4px 0;font-size:11px"><span>Phone:</span><span>${s.customer_phone}</span></div>`:''}<div style="border-top:1px dashed #ccc;margin:12px 0"></div>${(s.sale_items||[]).map(i=>`<div style="margin:6px 0"><div style="font-size:11px">${i.name}</div><div style="display:flex;justify-content:space-between;font-size:10px;color:#666"><span>${i.quantity} x ${m(i.unit_price)}</span><span>${m(i.line_total)}</span></div></div>`).join('')}<div style="border-top:1px dashed #ccc;margin:12px 0"></div><div style="display:flex;justify-content:space-between;margin:4px 0;font-size:11px"><span>Subtotal</span><span>${m(s.subtotal)}</span></div>${n(s.discount)>0?`<div style="display:flex;justify-content:space-between;margin:4px 0;font-size:11px"><span>Discount</span><span>-${m(s.discount)}</span></div>`:''}<div style="display:flex;justify-content:space-between;font-weight:700;font-size:14px;margin-top:8px"><span>TOTAL</span><span>${m(s.total)}</span></div><div style="border-top:1px dashed #ccc;margin:12px 0"></div><div style="display:flex;justify-content:space-between;margin:4px 0;font-size:11px"><span>Payment</span><span>${(s.payment_method||'').toUpperCase()}</span></div><div style="text-align:center;margin-top:16px;font-size:10px;color:#64748b;line-height:1.6">Thank you!<br>Find us on Google Maps</div></div>`;openMod('rcptModal')}
function printRcpt(){if(currentRcpt)printThermalReceipt(currentRcpt)}
function renderReceipts(){const q=($('rcQ')?.value||'').toLowerCase();$('rcTbl').innerHTML=sales.filter(s=>s.receipt_no.toLowerCase().includes(q)||(s.customer_name||'').toLowerCase().includes(q)||(s.customer_phone||'').includes(q)).slice(0,100).map(s=>`<tr${s.status==='voided'?' style="opacity:.5"':''}><td><b style="color:var(--primary)">${s.receipt_no}</b></td><td>${fmtD(s.created_at)}</td><td>${s.customer_name||'Walk-in'}<br><small style="color:#94a3b8">${s.customer_phone||''}</small></td><td><b>${m(s.total)}</b></td><td><div class="action-btns"><button class="btn btn-ghost btn-sm" onclick="viewRcpt('${s.id}')">ğŸ‘ï¸</button><button class="btn btn-primary btn-sm" onclick="printRcptById('${s.id}')">ğŸ–¨ï¸</button></div></td></tr>`).join('')||'<tr><td colspan="5"><div class="tbl-empty"><span>ğŸ§¾</span>None</div></td></tr>'}
function viewRcpt(id){const s=sales.find(x=>x.id===id);if(s)showRcpt(s)}
function printRcptById(id){const s=sales.find(x=>x.id===id);if(s)printThermalReceipt(s)}
function setOrderFilter(f){orderFilter=f;document.querySelectorAll('.tabs .tab').forEach(t=>t.classList.remove('on'));event.target.classList.add('on');renderOrders()}
function renderOrders(){$('orderPendingCount').textContent=orders.filter(o=>o.status==='pending').length;const filt=orderFilter==='all'?orders:orders.filter(o=>o.status===orderFilter);$('ordersList').innerHTML=filt.length?filt.map(o=>{const items=o.whatsapp_order_items||[];return`<div class="order-card ${o.status}"><div class="order-head"><div class="order-id">${o.order_no}</div><div class="order-time">${fmtDT(o.created_at)}</div></div><div style="margin-bottom:10px"><span class="order-status ${o.status}">${o.status.toUpperCase()}</span></div><div class="order-customer"><div class="order-avatar">ğŸ‘¤</div><div class="order-info"><h4>${o.customer_name||'Customer'}</h4><p>ğŸ“± ${o.customer_phone||'-'}</p></div></div><div style="margin-bottom:12px">${items.slice(0,4).map(i=>`<div class="order-item"><span>${i.quantity}x ${i.name}</span><b>${m(i.line_total)}</b></div>`).join('')}</div><div class="order-footer"><div class="order-total">${m(o.total)}</div><div class="action-btns">${o.status==='pending'?`<button class="btn btn-success btn-sm" onclick="completeOrder('${o.id}')">âœ…</button><button class="btn btn-danger btn-sm" onclick="cancelOrder('${o.id}')">âŒ</button>`:''}</div></div></div>`}).join(''):'<div class="tbl-empty"><span>ğŸ›ï¸</span><p>None</p></div>';renderOrderBadge()}
async function completeOrder(id){const o=orders.find(x=>x.id===id);if(!o||!confirm('Complete?'))return;show('...');const rcptNo='ER-'+Date.now().toString(36).toUpperCase();const{data:sale}=await db.from('sales').insert({shop_id:shop.id,user_id:user.id,receipt_no:rcptNo,customer_name:o.customer_name,customer_phone:o.customer_phone,subtotal:n(o.total),discount:0,total:n(o.total),profit:0,payment_method:'online',sale_type:'online'}).select().single();await db.from('whatsapp_orders').update({status:'completed',sale_id:sale?.id,completed_at:new Date().toISOString()}).eq('id',id);hide();toast('Done','success');await loadAllData()}
async function cancelOrder(id){const reason=prompt('Reason:');if(!reason)return;show('...');await db.from('whatsapp_orders').update({status:'cancelled',cancel_reason:reason,cancelled_at:new Date().toISOString()}).eq('id',id);hide();toast('Cancelled','warning');await loadOrders();renderOrders()}
function renderProducts(){const q=($('prQ')?.value||'').toLowerCase();$('prTbl').innerHTML=products.filter(p=>p.name.toLowerCase().includes(q)).map(p=>{const qt=n(p.quantity);const img=p.image_url?`<img src="${p.image_url}" style="width:40px;height:40px;object-fit:cover;border-radius:8px">`:'ğŸ“¦';return`<tr><td>${img}</td><td><b>${p.name}</b><br><small style="color:#94a3b8">${p.category||''}</small></td><td style="color:var(--primary);font-weight:700">${m(p.price)}</td><td style="font-weight:700;color:${qt===0?'var(--danger)':qt<=5?'var(--warning)':'inherit'}">${qt}</td><td><div class="action-btns"><button class="btn btn-ghost btn-sm" onclick="editProduct('${p.id}')">âœï¸</button><button class="btn btn-danger btn-sm" onclick="delProduct('${p.id}')">ğŸ—‘ï¸</button></div></td></tr>`}).join('')||'<tr><td colspan="5"><div class="tbl-empty">None</div></td></tr>'}
function openProductModal(){$('prModalTitle').textContent='Add Product';$('ePrId').value='';$('prName').value='';$('prCat').value='';$('prCost').value='';$('prPrice').value='';$('prWhole').value='';$('prQty').value='';$('prImgUrl').value='';$('prImgUpload').innerHTML='<span>ğŸ“·</span><p>Upload</p><input type="file" id="prImgInput" accept="image/*" onchange="previewImg(this)">';openMod('prModal')}
function editProduct(id){const p=products.find(x=>x.id===id);if(!p)return;$('prModalTitle').textContent='Edit';$('ePrId').value=p.id;$('prName').value=p.name;$('prCat').value=p.category||'';$('prCost').value=p.cost_price;$('prPrice').value=p.price;$('prWhole').value=p.wholesale_price||'';$('prQty').value=p.quantity;$('prImgUrl').value=p.image_url||'';$('prImgUpload').innerHTML=p.image_url?`<img src="${p.image_url}"><input type="file" id="prImgInput" accept="image/*" onchange="previewImg(this)">`:'<span>ğŸ“·</span><p>Upload</p><input type="file" id="prImgInput" accept="image/*" onchange="previewImg(this)">';openMod('prModal')}
function previewImg(inp){if(inp.files&&inp.files[0]){const r=new FileReader();r.onload=e=>{$('prImgUpload').innerHTML=`<img src="${e.target.result}"><input type="file" id="prImgInput" accept="image/*" onchange="previewImg(this)">`;$('prImgUrl').value=e.target.result};r.readAsDataURL(inp.files[0])}}
async function saveProduct(){const id=$('ePrId').value,data={shop_id:shop.id,name:$('prName').value.trim(),category:$('prCat').value.trim()||null,cost_price:n($('prCost').value),price:n($('prPrice').value),wholesale_price:n($('prWhole').value),quantity:n($('prQty').value),image_url:$('prImgUrl').value||null};if(!data.name||!data.price){toast('Required','error');return}show('...');let error;if(id)({error}=await db.from('products').update(data).eq('id',id));else({error}=await db.from('products').insert(data));hide();if(error){toast('Error','error');return}toast('Saved','success');closeMod('prModal');await loadProducts();renderProducts();renderPOS()}
async function delProduct(id){if(!confirm('Delete?'))return;show('...');await db.from('products').update({active:false}).eq('id',id);hide();toast('Deleted','success');await loadProducts();renderProducts();renderPOS()}
function renderBundles(){$('bundlesList').innerHTML=bundles.length?bundles.map(b=>{const items=b.bundle_items||[];const reg=items.reduce((a,i)=>a+n(i.products?.price||0)*n(i.quantity),0);const save=reg-n(b.bundle_price);return`<div class="card" style="border-left:4px solid #8b5cf6"><div style="display:flex;justify-content:space-between;margin-bottom:12px"><div><b style="font-size:16px">ğŸ ${b.name}</b><div style="font-size:22px;font-weight:800;color:var(--primary);margin-top:4px">${m(b.bundle_price)}</div></div>${save>0?`<span class="badge badge-success">Save ${m(save)}</span>`:''}</div><div style="margin-bottom:12px">${items.map(i=>`<div style="font-size:13px;color:#64748b;padding:4px 0">â€¢ ${i.quantity}x ${i.products?.name||'Product'}</div>`).join('')}</div><div class="action-btns"><button class="btn btn-ghost btn-sm" onclick="editBundle('${b.id}')">âœï¸</button><button class="btn btn-danger btn-sm" onclick="delBundle('${b.id}')">ğŸ—‘ï¸</button></div></div>`}).join(''):'<div class="tbl-empty"><span>ğŸ</span><p>None</p></div>'}
function openBundleModal(){$('bundleModalTitle').textContent='Create Bundle';$('eBundleId').value='';$('bundleName').value='';$('bundlePrice').value='';$('bundleProds').innerHTML=products.map(p=>`<label style="display:flex;align-items:center;gap:8px;padding:8px;cursor:pointer;font-size:13px"><input type="checkbox" class="bp-chk" data-id="${p.id}" style="width:18px;height:18px"><span>${p.name}</span><span style="margin-left:auto;color:var(--primary);font-weight:600">${m(p.price)}</span></label>`).join('');openMod('bundleModal')}
function editBundle(id){const b=bundles.find(x=>x.id===id);if(!b)return;$('bundleModalTitle').textContent='Edit Bundle';$('eBundleId').value=b.id;$('bundleName').value=b.name;$('bundlePrice').value=b.bundle_price;const sel=(b.bundle_items||[]).map(i=>i.product_id);$('bundleProds').innerHTML=products.map(p=>`<label style="display:flex;align-items:center;gap:8px;padding:8px;cursor:pointer;font-size:13px"><input type="checkbox" class="bp-chk" data-id="${p.id}" ${sel.includes(p.id)?'checked':''} style="width:18px;height:18px"><span>${p.name}</span><span style="margin-left:auto;color:var(--primary);font-weight:600">${m(p.price)}</span></label>`).join('');openMod('bundleModal')}
async function saveBundle(){const id=$('eBundleId').value,name=$('bundleName').value.trim(),price=n($('bundlePrice').value);if(!name||!price){toast('Required','error');return}const prods=[...document.querySelectorAll('.bp-chk:checked')].map(c=>c.dataset.id);if(!prods.length){toast('Select products','error');return}show('...');let bid=id;if(id){await db.from('bundles').update({name,bundle_price:price}).eq('id',id);await db.from('bundle_items').delete().eq('bundle_id',id)}else{const{data}=await db.from('bundles').insert({shop_id:shop.id,name,bundle_price:price}).select().single();bid=data?.id}if(bid)await db.from('bundle_items').insert(prods.map(pid=>({bundle_id:bid,product_id:pid,quantity:1})));hide();toast('Saved','success');closeMod('bundleModal');await loadBundles();renderBundles();renderPOS()}
async function delBundle(id){if(!confirm('Delete?'))return;show('...');await db.from('bundles').update({active:false}).eq('id',id);hide();toast('Deleted','success');await loadBundles();renderBundles();renderPOS()}
function renderCustomers(){$('custTotal').textContent=customers.length;$('custPoints').textContent=customers.reduce((a,c)=>a+n(c.loyalty_points),0);$('custRevenue').textContent=m(customers.reduce((a,c)=>a+n(c.total_purchases),0));const q=($('custQ')?.value||'').toLowerCase();const filt=customers.filter(c=>(c.phone||'').includes(q)||(c.name||'').toLowerCase().includes(q));$('customersList').innerHTML=filt.length?filt.map(c=>`<div class="customer-item" onclick="viewCustomer('${c.id}')"><div class="customer-avatar">${c.name.charAt(0)}</div><div class="customer-info"><div class="customer-name">${c.name}</div><div class="customer-phone">ğŸ“± ${c.phone||'-'}</div><div class="customer-stats"><div><span class="customer-stat-value">${n(c.total_visits)}</span> <span class="customer-stat-label">visits</span></div><div><span class="customer-stat-value">${m(c.total_purchases)}</span> <span class="customer-stat-label">spent</span></div><div><span class="customer-stat-value">${n(c.loyalty_points)}</span> <span class="customer-stat-label">pts</span></div></div></div></div>`).join(''):'<p style="text-align:center;color:#94a3b8;padding:32px">None</p>'}
function openCustomerModal(){$('custModalTitle').textContent='Add Customer';$('eCustId').value='';$('custName').value='';$('custPhone').value='';$('custAddress').value='';$('custNotes').value='';openMod('custModal')}
function viewCustomer(id){const c=customers.find(x=>x.id===id);if(!c)return;$('custModalTitle').textContent='Edit Customer';$('eCustId').value=c.id;$('custName').value=c.name;$('custPhone').value=c.phone||'';$('custAddress').value=c.address||'';$('custNotes').value=c.notes||'';openMod('custModal')}
async function saveCustomer(){const id=$('eCustId').value,data={shop_id:shop.id,name:$('custName').value.trim(),phone:$('custPhone').value.trim(),address:$('custAddress').value.trim()||null,notes:$('custNotes').value.trim()||null};if(!data.name||!data.phone){toast('Required','error');return}show('...');let error;if(id)({error}=await db.from('customers').update(data).eq('id',id));else({error}=await db.from('customers').insert(data));hide();if(error){toast('Error','error');return}toast('Saved','success');closeMod('custModal');await loadCustomers();renderCustomers()}
function renderExpenses(){const mo=new Date().toISOString().slice(0,7);let tot=0;for(const e of expenses)if(e.created_at.slice(0,7)===mo)tot+=n(e.amount);$('expMonthTotal').textContent=m(tot);$('expensesList').innerHTML=expenses.length?expenses.slice(0,50).map(e=>`<div class="expense-item"><div class="expense-icon">${catIcon(e.category)}</div><div class="expense-info"><div class="expense-title">${e.title}</div><div class="expense-date">${fmtD(e.created_at)} â€¢ ${e.category}</div></div><div class="expense-amount">-${m(e.amount)}</div><button class="btn btn-danger btn-sm" onclick="delExpense('${e.id}')">ğŸ—‘ï¸</button></div>`).join(''):'<div class="tbl-empty"><span>ğŸ’¸</span><p>None</p></div>'}
function openExpenseModal(){$('expTitle').value='';$('expCat').value='utilities';$('expAmt').value='';$('expNotes').value='';openMod('expModal')}
async function saveExpense(){const title=$('expTitle').value.trim(),amount=n($('expAmt').value);if(!title||!amount){toast('Required','error');return}show('...');const{error}=await db.from('expenses').insert({shop_id:shop.id,user_id:user.id,title,category:$('expCat').value,amount,notes:$('expNotes').value.trim()||null});hide();if(error){toast('Error','error');return}toast('Added','success');closeMod('expModal');await loadExpenses();renderExpenses();renderDash()}
async function delExpense(id){if(!confirm('Delete?'))return;show('...');await db.from('expenses').delete().eq('id',id);hide();toast('Deleted','success');await loadExpenses();renderExpenses();renderDash()}
function initReports(){const t=new Date(),y=t.getFullYear(),mo=t.getMonth();$('repFrom').value=new Date(y,mo,1).toISOString().split('T')[0];$('repTo').value=t.toISOString().split('T')[0];renderReports()}
function renderReports(){const from=$('repFrom').value,to=$('repTo').value;let tS=0,tP=0;const ps={};for(const s of sales){if(s.status==='voided')continue;const d=isoD(s.created_at);if(d>=from&&d<=to){tS+=n(s.total);tP+=n(s.profit);for(const i of(s.sale_items||[])){if(!ps[i.name])ps[i.name]={qty:0,total:0};ps[i.name].qty+=i.quantity;ps[i.name].total+=n(i.line_total)}}}let tE=0;for(const e of expenses){const d=isoD(e.created_at);if(d>=from&&d<=to)tE+=n(e.amount)}const net=tP-tE;$('repSales').textContent=m(tS);$('repProfit').textContent=m(tP);$('repExpenses').textContent=m(tE);$('repNet').textContent=m(net);$('repNet').className='value '+(net>=0?'success':'danger');const top=Object.entries(ps).sort((a,b)=>b[1].total-a[1].total).slice(0,10);$('topProductsList').innerHTML=top.length?top.map((p,i)=>`<div class="top-product"><div class="top-product-rank">${i+1}</div><div class="top-product-info"><div class="top-product-name">${p[0]}</div><div class="top-product-qty">${p[1].qty} sold</div></div><div class="top-product-total">${m(p[1].total)}</div></div>`).join(''):'<p style="color:#94a3b8;text-align:center;padding:24px">No data</p>'}
function renderStaff(){$('sfTbl').innerHTML=staff.map(s=>`<tr><td><b>${s.name}</b></td><td><span class="badge badge-${s.role==='admin'?'primary':'success'}">${s.role}</span></td><td><span class="badge badge-${s.active?'success':'danger'}">${s.active?'Active':'Off'}</span></td><td><div class="action-btns"><button class="btn btn-ghost btn-sm" onclick="editStaff('${s.id}')">âœï¸</button><button class="btn btn-danger btn-sm" onclick="delStaff('${s.id}')">ğŸ—‘ï¸</button></div></td></tr>`).join('')||'<tr><td colspan="4"><div class="tbl-empty">None</div></td></tr>'}
function openStaffModal(){$('sfModalTitle').textContent='Add Staff';$('eSfId').value='';$('sfName').value='';$('sfRole').value='cashier';$('sfPin').value='';openMod('sfModal')}
function editStaff(id){const s=staff.find(x=>x.id===id);if(!s)return;$('sfModalTitle').textContent='Edit Staff';$('eSfId').value=s.id;$('sfName').value=s.name;$('sfRole').value=s.role;$('sfPin').value=s.pin;openMod('sfModal')}
async function saveStaff(){const id=$('eSfId').value,data={shop_id:shop.id,name:$('sfName').value.trim(),role:$('sfRole').value,pin:$('sfPin').value.trim(),active:true};if(!data.name||data.pin.length!==4){toast('Name & 4-digit PIN','error');return}show('...');let error;if(id)({error}=await db.from('users').update(data).eq('id',id));else({error}=await db.from('users').insert(data));hide();if(error){toast('Error','error');return}toast('Saved','success');closeMod('sfModal');await loadStaff();renderStaff()}
async function delStaff(id){if(!confirm('Delete?'))return;show('...');await db.from('users').update({active:false}).eq('id',id);hide();toast('Deleted','success');await loadStaff();renderStaff()}
function renderStockTake(){const active=stockTakes.find(st=>st.status==='in_progress');if(active){currentStockTake=active;renderActiveStockTake()}else{currentStockTake=null;$('stockTakeArea').innerHTML=`<div class="card" style="text-align:center;padding:48px"><span style="font-size:64px;opacity:.2">ğŸ“‹</span><p style="color:#64748b;margin:20px 0">No active stock take</p><button class="btn btn-primary" onclick="startNewStockTake()">â• Start New</button></div>`}}
async function startNewStockTake(){if(currentStockTake){toast('Complete current first','error');return}if(!confirm('Start stock take?'))return;show('...');const refNo='ST-'+Date.now().toString(36).toUpperCase();const{data:st,error}=await db.from('stock_takes').insert({shop_id:shop.id,user_id:user.id,reference_no:refNo,status:'in_progress',total_items:products.length}).select().single();if(error){hide();toast('Error','error');return}const items=products.map(p=>({stock_take_id:st.id,product_id:p.id,product_name:p.name,system_qty:n(p.quantity),counted_qty:null,variance:0,variance_value:0}));await db.from('stock_take_items').insert(items);hide();toast(refNo,'success');await loadStockTakes();renderStockTake()}
function renderActiveStockTake(){const st=currentStockTake,items=st.stock_take_items||[];const counted=items.filter(i=>i.counted_qty!==null).length;const pct=items.length?Math.round(counted/items.length*100):0;const totVar=items.reduce((a,i)=>a+n(i.variance),0);const varVal=items.reduce((a,i)=>a+n(i.variance_value),0);$('stockTakeArea').innerHTML=`<div class="card"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><div><b style="font-size:18px">ğŸ“‹ ${st.reference_no}</b><div style="font-size:13px;color:#64748b;margin-top:4px">${fmtDT(st.created_at)}</div></div><span class="badge badge-warning">In Progress</span></div><div class="stock-summary"><div class="stock-summary-card"><div class="stock-summary-value">${counted}/${items.length}</div><div class="stock-summary-label">Counted</div></div><div class="stock-summary-card"><div class="stock-summary-value" style="color:${totVar>=0?'var(--success)':'var(--danger)'}">${totVar>=0?'+':''}${totVar}</div><div class="stock-summary-label">Variance</div></div><div class="stock-summary-card"><div class="stock-summary-value" style="color:${varVal>=0?'var(--success)':'var(--danger)'}">${m(Math.abs(varVal))}</div><div class="stock-summary-label">Value</div></div></div><div class="stock-progress"><div class="stock-progress-bar" style="width:${pct}%"></div></div><p style="text-align:center;font-size:13px;color:#64748b;margin-bottom:16px">${pct}%</p><div style="display:flex;gap:10px;margin-bottom:20px"><button class="btn btn-success" onclick="completeStockTake()" ${pct<100?'disabled':''}>âœ… Complete</button><button class="btn btn-danger" onclick="cancelStockTake()">âŒ Cancel</button></div><input type="text" class="field-input" placeholder="ğŸ” Search..." id="stQ" oninput="filterStockItems()" style="margin-bottom:16px"><div id="stockItems">${renderStockItems(items)}</div></div>`}
function renderStockItems(items){const q=($('stQ')?.value||'').toLowerCase();const filt=items.filter(i=>i.product_name.toLowerCase().includes(q));return filt.map(i=>{const v=n(i.variance);const cls=i.counted_qty===null?'':(v>0?'pos':v<0?'neg':'counted');return`<div class="stock-item ${cls}"><div class="stock-item-info"><div class="stock-item-name">${i.product_name}</div></div><div class="stock-qty"><div class="stock-qty-label">System</div><div class="stock-qty-value">${i.system_qty}</div></div><div><input type="number" class="stock-qty-input" value="${i.counted_qty!==null?i.counted_qty:''}" placeholder="?" min="0" onchange="updateStockCount('${i.id}',this.value)"></div><div class="stock-variance ${v>0?'pos':v<0?'neg':'zero'}">${v>0?'+':''}${v}</div></div>`}).join('')||'<p style="text-align:center;color:#94a3b8;padding:24px">None</p>'}
function filterStockItems(){if(!currentStockTake)return;$('stockItems').innerHTML=renderStockItems(currentStockTake.stock_take_items||[])}
async function updateStockCount(itemId,val){const counted=val===''?null:n(val);const item=(currentStockTake.stock_take_items||[]).find(i=>i.id===itemId);if(!item)return;const variance=counted!==null?counted-item.system_qty:0;const prod=products.find(p=>p.id===item.product_id);const varVal=variance*(prod?n(prod.cost_price):0);await db.from('stock_take_items').update({counted_qty:counted,variance,variance_value:varVal,counted_at:counted!==null?new Date().toISOString():null}).eq('id',itemId);item.counted_qty=counted;item.variance=variance;item.variance_value=varVal;renderActiveStockTake()}
async function completeStockTake(){if(!currentStockTake||!confirm('Complete & apply?'))return;show('...');const items=currentStockTake.stock_take_items||[];for(const i of items)if(i.counted_qty!==null&&i.product_id)await db.from('products').update({quantity:i.counted_qty}).eq('id',i.product_id);const totVar=items.reduce((a,i)=>a+n(i.variance),0);const varVal=items.reduce((a,i)=>a+n(i.variance_value),0);await db.from('stock_takes').update({status:'completed',completed_at:new Date().toISOString(),total_variance:totVar,variance_value:varVal}).eq('id',currentStockTake.id);hide();toast('Completed','success');await loadProducts();await loadStockTakes();renderStockTake();renderPOS()}
async function cancelStockTake(){if(!currentStockTake||!confirm('Cancel?'))return;show('...');await db.from('stock_takes').update({status:'cancelled'}).eq('id',currentStockTake.id);hide();toast('Cancelled','warning');await loadStockTakes();renderStockTake()}
function viewStockHistory(){const completed=stockTakes.filter(st=>st.status!=='in_progress');$('stockHistBody').innerHTML=completed.length?completed.map(st=>`<div class="card" style="margin-bottom:12px;border-left:4px solid ${st.status==='completed'?'var(--success)':'var(--danger)'}"><div style="display:flex;justify-content:space-between;align-items:center"><b>${st.reference_no}</b><span class="badge badge-${st.status==='completed'?'success':'danger'}">${st.status}</span></div><div style="font-size:13px;color:#64748b;margin-top:8px">${fmtDT(st.created_at)}</div><div style="font-size:14px;margin-top:12px">Variance: <b style="color:${n(st.total_variance)>=0?'var(--success)':'var(--danger)'}">${n(st.total_variance)>=0?'+':''}${n(st.total_variance)}</b> (${m(st.variance_value||0)})</div></div>`).join(''):'<p style="text-align:center;color:#94a3b8;padding:32px">No history</p>';openMod('stockHistModal')}
document.addEventListener('DOMContentLoaded',init);
</script>
</body>
</html>
